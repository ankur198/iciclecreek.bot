@page "/"
@inject HttpClient Http
@inherits LayoutComponentBase
<!-- layout -->
<div class="grid">
    <TextEdit Class="grid-query" Placeholder="Enter utterance..." Text="@Text" TextChanged="@OnTextChanged" DelayTextOnKeyPress="true" />

    <Text Class="grid-yamlheading">Lucy Yaml file</Text>

    <MonacoEditorYaml @ref="yamlEditor" Id="monacoEditorYaml" Value="@Yaml" CssClass="grid-yaml" />

    <Alert Class="grid-alert" Color="Color.Warning" @bind-IsShow="ShowAlert">
        <TextEdit IsPlaintext="true" @bind-Text="@Error" />
    </Alert>

    <Text Class="grid-resultheading">Entities</Text>

    <Accordion Class="grid-results">
        <Collapse Visible="@TopResultVisible">
            <CollapseHeader>
                <Heading Size="HeadingSize.Is6">
                    <Button Clicked="@(()=> TopResultVisible= !TopResultVisible)">Top Result</Button>
                </Heading>
            </CollapseHeader>
            <CollapseBody>
                <text>@Elapsed</text>
                <plaintext>@TopResult</plaintext>
            </CollapseBody>
        </Collapse>
        <Collapse Visible="@AllResultsVisible">
            <CollapseHeader>
                <Heading Size="HeadingSize.Is6">
                    <Button Clicked="@(()=>AllResultsVisible= !AllResultsVisible)">All Results</Button>
                </Heading>
            </CollapseHeader>
            <CollapseBody>
                <plaintext>@EntityResults</plaintext>
            </CollapseBody>
        </Collapse>
    </Accordion>
</div>


@functions {

   private MonacoEditorYaml yamlEditor;

    private LucyEngine engine = null;
    private LucyRecognizer recognizer = null;
    private string lucyModel = null;
    private JsonConverter patternModelConverter = new PatternModelConverter();

    private IDeserializer yamlDeserializer = new DeserializerBuilder()
                                                .WithNamingConvention(CamelCaseNamingConvention.Instance)
                                                .Build();
    private ISerializer yamlToJsonSerializer = new SerializerBuilder()
                                            .JsonCompatible()
                                            .Build();

    public bool TopResultVisible = true;

    public bool AllResultsVisible = false;

    public string Yaml { get; set; }

    public string TopResult { get; set; }

    public string EntityResults { get; set; }

    public string Text { get; set; }

    public string Error { get; set; }

    public string Elapsed { get; set; }

    private bool ShowAlert { get { return !String.IsNullOrEmpty(this.Error); } set { } }

    protected override void OnInitialized()
    {
        this.Yaml = LoadResource("LucyPad2.Client.lucy.yaml");
    }


    private string LoadResource(string name)
    {
        var assembly = Assembly.GetExecutingAssembly();
        using (Stream stream = assembly.GetManifestResourceStream(name))
        {
            using (StreamReader reader = new StreamReader(stream))
            {
                return reader.ReadToEnd();
            }
        }

    }

    async Task OnTextChanged(string value)
    {
        try
        {
            var yaml = await yamlEditor.GetValue();
            var text = value.Trim() ?? string.Empty;
            IEnumerable<LucyEntity> results = null;
            if (text.Length > 0)
            {
#if embedded
                if (lucyModel != yaml)
                {
                    LoadModel(yaml);
                }

                var sw = new System.Diagnostics.Stopwatch();
                sw.Start();
                results = engine.MatchEntities(text);
                sw.Stop();
                this.Elapsed = $"{sw.Elapsed.TotalMilliseconds} ms";

@*var activity = new Activity(ActivityTypes.Message) { Text = text };
    var tc = new TurnContext(new TestAdapter(), activity);
    var dc = new DialogContext(new DialogSet(), tc, new DialogState());
    var recognizerResult = recognizer.RecognizeAsync(dc, activity).Result;
    // this.recognizerBox.Text = JsonConvert.SerializeObject(recognizerResult, new JsonSerializerSettings() { Formatting = Formatting.Indented, NullValueHandling = NullValueHandling.Ignore });
    this.recognizerBox.Text = new Serializer().Serialize(JObject.FromObject(recognizerResult).ToObject<ExpandoObject>());*@
#else
                var sw = new System.Diagnostics.Stopwatch();
                sw.Start();
                var result = await Http.PostAsJsonAsync("entities", new
                {
                    yaml,
                    text
                });
                sw.Stop();
                this.Elapsed = $"{sw.Elapsed.TotalMilliseconds} ms";
                results = JsonConvert.DeserializeObject<LucyEntity[]>(await result.Content.ReadAsStringAsync());
#endif
            }

            this.TopResultVisible = true;
                this.AllResultsVisible = false;
                this.TopResult = LucyEngine.VisualizeEntity(text, results.FirstOrDefault());
                this.EntityResults = String.Join("\n\n", results.Select(entity => LucyEngine.VisualizeEntity(text, entity)));
            }
        catch (SemanticErrorException err)
        {
            this.Error = err.Message;
            //this.editor.ScrollToLine(err.Start.Line);
            //var line = this.editor.Document.GetLineByNumber(err.Start.Line - 1);
            //this.editor.Select(line.Offset, line.Length);
        }
        catch (SyntaxErrorException err)
        {
            this.Error = err.Message;
            //this.error.Visibility = Visibility.Visible;
            //this.editor.ScrollToLine(err.Start.Line);
            //var line = this.editor.Document.GetLineByNumber(err.Start.Line - 1);
            //this.editor.Select(line.Offset, line.Length);
        }
        catch (Exception err)
        {
            this.Error = err.Message;
            //this.error.Content = err.Message;
            //this.error.Visibility = Visibility.Visible;
        }
    }

    private void LoadModel(string yaml)
    {
        // Trace.TraceInformation("Loading model");
        var reader = new StringReader(yaml);
        var x = yamlDeserializer.Deserialize(new StringReader(yaml));
        var json = yamlToJsonSerializer.Serialize(x);
        var model = JsonConvert.DeserializeObject<LucyModel>(json, patternModelConverter);
        engine = new LucyEngine(model, useAllBuiltIns: true);
        recognizer = new LucyRecognizer()
        {
            Model = model,
        };

            @*StringBuilder sb = new StringBuilder();
                for (int i = 0; i < 100; i++)
                {
                    sb.AppendLine(engine.GenerateExample("desireIntent"));
                }*@
            // this.examplesBox.Text = sb.ToString();

            if (engine.Warnings.Any())
            {
                this.Error = String.Join("\n", engine.Warnings);
            }
            else
            {
                this.Error = null;
            }
            lucyModel = yaml;
        }
}
